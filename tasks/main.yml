---
# tasks file for osp-vm

  - name: talk to the api and get auth
    os_auth:
      cert: "{{ user_cert }}"
      key: "{{ user_key }}"
      cacert: "{{ user_cacert }}"
      region_name: "{{ region }}"

  - name: get facts about about the VM's
    os_server_facts:
      cert: "{{ user_cert }}"
      key: "{{ user_key }}"
      cacert: "{{ user_cacert }}"
      region_name: "{{ region }}"
      server: "{{ server_name }}"
    debug:
      var: openstack_servers
    register: found_vm

  - name: create VM if is not there
    os_server:
      cert: "{{ user_cert }}" 
      key: "{{ user_key }}"
      cacert: "{{ user_cacert }}"
      region_name: "{{ osp_vm.region_name }}"
      auth:  "{{ osp_vm.auth }}"
      name: "{{ item.1.vm.name }}"
      image: "{{ item.1.vm.image }}"
      flavor: "{{ item.1.vm.flavor }}"
      network: "{{ item.1.vm.network }}"
      auto_ip: "{{ item.1.vm.auto_ip }}"
      key_name: "{{ item.1.vm.key_name }}"
      state: "{{ item.1.vm.server_state }}"
      with_subelements:
        - "{{ osp_vm.vm }}"



